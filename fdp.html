<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FDP - Multiplayer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700;900&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap');

        :root {
            --neon-green: #0aff60;
            --neon-purple: #b537f2;
            --neon-pink: #ff2a6d;
            --neon-yellow: #f5e625;
            --bg-dark: #080808;
            --glass: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.15);
            --font-display: 'Space Grotesk', sans-serif;
            --font-data: 'Space Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-dark);
            color: white;
            height: 100vh; width: 100vw; overflow: hidden;
            font-family: var(--font-display);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        /* --- BACKGROUND FX --- */
        .noise { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://grainy-gradients.vercel.app/noise.svg'); opacity: 0.05; pointer-events: none; z-index: 0; }
        .ambilight-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.4; filter: blur(120px); background: radial-gradient(circle at 50% 30%, #333, #000); transition: background 2s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .app-container { 
            position: relative; width: 100%; height: 100%; max-width: 500px; z-index: 10; 
            display: flex; flex-direction: column; padding: 15px;
            /* Layout flex√≠vel para garantir que tudo caiba */
            justify-content: space-between;
        }

        /* --- UI COMPONENTS --- */
        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 5px; margin-bottom: 5px;
        }
        .badge { 
            background: var(--glass); padding: 6px 12px; border-radius: 50px; 
            font-family: var(--font-data); font-size: 0.75rem; font-weight: bold; 
            border: 1px solid var(--border); display: flex; align-items: center; gap: 8px;
            backdrop-filter: blur(10px);
        }

        /* CARTAS */
        .fdp-card {
            padding: 24px; border-radius: 20px; font-weight: 800; font-size: 1.2rem; line-height: 1.3;
            min-height: 200px; display: flex; flex-direction: column; justify-content: space-between;
            position: relative; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        
        .card-black { 
            background: rgba(20,20,20,0.95); color: white; border: 1px solid rgba(255,255,255,0.2); 
            margin-bottom: 10px; z-index: 5;
        }
        
        .card-white { 
            background: white; color: black; border: none; cursor: pointer; 
            transform-origin: center bottom;
        }

        /* √ÅREA DA MESA (ONDE AS CARTAS S√ÉO JOGADAS) */
        .table-area { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; 
            padding: 10px; flex-grow: 1; overflow-y: auto; align-content: start;
            min-height: 150px;
        }
        
        .table-card { 
            min-height: 130px; font-size: 0.95rem; padding: 15px; 
            animation: dealCard 0.4s backwards; 
        }
        
        /* M√ÉO DO JOGADOR */
        .hand-area {
            height: 220px; flex-shrink: 0; display: flex; align-items: flex-end;
            overflow-x: auto; overflow-y: hidden; scrollbar-width: none;
            padding: 20px 20px 10px 20px; margin: 0 -15px;
            perspective: 1000px;
        }
        
        .hand-card { 
            min-width: 150px; width: 150px; height: 210px; font-size: 1rem; 
            margin-right: -60px; /* Sobreposi√ß√£o estilo leque */
            border-radius: 16px; border: 1px solid #ddd;
            transition: transform 0.3s ease, margin 0.3s ease;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
        }
        .hand-card:last-child { margin-right: 0; }
        
        /* Estado Hover/Selected na m√£o */
        .hand-card:hover, .hand-card.selected { 
            transform: translateY(-50px) rotate(0deg) scale(1.1); 
            z-index: 100; margin-right: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }
        .hand-card.selected { border: 4px solid var(--neon-green); }

        /* BOT√ïES E STATUS */
        .status-container { text-align: center; margin: 5px 0; min-height: 25px; }
        .status-msg { 
            color: var(--neon-pink); font-family: var(--font-data); font-size: 0.8rem; 
            text-transform: uppercase; letter-spacing: 2px; font-weight: bold;
            animation: pulseText 2s infinite;
        }

        .btn-action-container {
            position: absolute; bottom: 30px; left: 0; width: 100%; 
            padding: 0 30px; z-index: 200; pointer-events: none;
        }
        .btn { 
            background: var(--neon-green); color: black; border: none; padding: 18px; 
            border-radius: 50px; font-weight: 900; font-size: 1.1rem; width: 100%; 
            text-transform: uppercase; cursor: pointer; pointer-events: auto;
            box-shadow: 0 0 30px rgba(10, 255, 96, 0.4); 
            transform: translateY(100px); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn.visible { transform: translateY(0); }
        .btn:active { transform: scale(0.95); }

        /* MODAL DE VENCEDOR */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.92); z-index: 500; display: none; 
            flex-direction: column; justify-content: center; align-items: center; 
            padding: 30px; text-align: center; backdrop-filter: blur(10px);
        }

        @keyframes dealCard { from { transform: translateY(50px) scale(0.8); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        #loading { position: fixed; inset:0; background:black; z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; font-family:var(--font-data); gap: 20px; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--neon-green); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsividade para telas pequenas */
        @media (max-height: 700px) {
            .fdp-card { min-height: 160px; font-size: 1rem; padding: 15px; }
            .hand-card { height: 180px; width: 130px; }
        }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <div style="letter-spacing: 2px;">CONECTANDO AO SUBMUNDO...</div>
</div>

<div class="noise"></div>
<div class="ambilight-bg" id="ambilight"></div>

<audio id="snd-play" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.m4a"></audio>
<audio id="snd-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.m4a"></audio>
<audio id="snd-deal" src="https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.m4a"></audio>

<div class="app-container">
    <div class="top-bar">
        <div class="badge"><i class="fa-solid fa-users"></i> <span id="room-code-display">????</span></div>
        <div class="badge" style="border-color: var(--neon-yellow); color: var(--neon-yellow);"><i class="fa-solid fa-star"></i> <span id="score-display">0</span></div>
    </div>

    <div style="position: relative; z-index: 10;">
        <div class="status-container">
            <span id="game-status" class="status-msg">CARREGANDO...</span>
        </div>
        <div id="black-card" class="fdp-card card-black">
            <span id="black-text">...</span>
            <div style="margin-top:auto; display:flex; justify-content:space-between; align-items:center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <span id="judge-indicator" style="font-size:0.75rem; font-family:var(--font-data); text-transform: uppercase; color: var(--neon-purple); font-weight: bold;">
                    <i class="fa-solid fa-gavel"></i> <span id="judge-name">...</span>
                </span>
                <i class="fa-solid fa-layer-group" style="opacity: 0.3;"></i>
            </div>
        </div>
    </div>

    <div id="table-area" class="table-area"></div>

    <div id="hand-area" class="hand-area"></div>

    <div class="btn-action-container">
        <button id="btn-action" class="btn">CONFIRMAR</button>
    </div>
</div>

<div id="winner-modal" class="modal">
    <div style="font-size: 4rem; margin-bottom: 20px;">üëë</div>
    <h2 style="color:var(--neon-yellow); margin-bottom:20px; letter-spacing: 3px; font-weight: 900;">VENCEDOR</h2>
    
    <div id="winner-card-display" class="fdp-card card-white" style="width:100%; max-width:320px; transform:rotate(-2deg); margin-bottom:30px; text-align: left; box-shadow: 0 0 50px rgba(255,255,255,0.2);">
        ...
    </div>
    
    <h1 id="winner-name" style="font-size:2rem; text-transform:uppercase; color: white;">NOME</h1>
    <p style="margin-top:30px; font-family:var(--font-data); opacity: 0.6; font-size: 0.8rem;">PR√ìXIMA RODADA EM BREVE...</p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, push, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIGURA√á√ÉO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyB1buacNarLY8ELWla6yeqTi4L0vTdloSc",
        authDomain: "wrapped-fad94.firebaseapp.com",
        databaseURL: "https://wrapped-fad94-default-rtdb.firebaseio.com",
        projectId: "wrapped-fad94",
        storageBucket: "wrapped-fad94.firebasestorage.app",
        messagingSenderId: "360236097664",
        appId: "1:360236097664:web:76777f529c18623bf1c665"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- VARI√ÅVEIS GLOBAIS ---
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');
    const myId = localStorage.getItem('wrapped_uid');
    
    // Verifica√ß√£o de seguran√ßa
    if(!roomCode || !myId) {
        alert("Erro: Voc√™ precisa entrar pelo Wrapped primeiro.");
        window.location.href = 'index.html';
    }

    let myName = "Eu";
    let isHost = false;
    let selectedCardIdx = -1;
    let hand = [];
    let whiteDeck = []; // Deck local para reposi√ß√£o
    
    // Elementos DOM
    const els = {
        loading: document.getElementById('loading'),
        roomCode: document.getElementById('room-code-display'),
        score: document.getElementById('score-display'),
        status: document.getElementById('game-status'),
        blackText: document.getElementById('black-text'),
        judgeName: document.getElementById('judge-name'),
        ambilight: document.getElementById('ambilight'),
        table: document.getElementById('table-area'),
        hand: document.getElementById('hand-area'),
        btnAction: document.getElementById('btn-action'),
        modal: document.getElementById('winner-modal'),
        winnerCard: document.getElementById('winner-card-display'),
        winnerName: document.getElementById('winner-name')
    };
    
    // Sounds
    const sounds = {
        play: document.getElementById('snd-play'),
        win: document.getElementById('snd-win'),
        deal: document.getElementById('snd-deal')
    };

    function playSound(id) {
        try { sounds[id].currentTime = 0; sounds[id].play(); } catch(e){}
    }

    // --- DATABASE DE CARTAS (150+) ---
    const blackCards = [
        "Para fazer amor gostoso, eu preciso de _____.", "O que o Bolsonaro esconde no cofre?", "Minha m√£e chorou quando viu _____.",
        "Qual √© o segredo para uma vida feliz?", "O que deu errado na minha vida sexual?", "Brasileiro gosta mesmo √© de _____.",
        "Em um mundo perfeito, n√£o existiria _____.", "O novo sabor de Doritos √©: _____.", "A causa da minha morte ser√° _____.",
        "O que eu trouxe da minha viagem ao Paraguai?", "Desculpe, professor, n√£o fiz o dever porque estava ocupado com _____.",
        "O que o Padre Marcelo Rossi toma no caf√© da manh√£?", "Qual √© o cheiro do transporte p√∫blico √†s 18h?",
        "O Brasil s√≥ vai para frente quando liberarem _____.", "Em briga de marido e mulher, ningu√©m mete _____.",
        "O que a Anitta vai lan√ßar no pr√≥ximo clipe?", "No meu vel√≥rio, eu quero que sirvam _____.", "Minha fantasia de carnaval esse ano √© _____.",
        "O que eu faria por um iPhone 15?", "O verdadeiro motivo do fim do mundo √© _____.", "O que eu encontrei no hist√≥rico do navegador do meu pai?",
        "A nova pol√≠tica da empresa pro√≠be _____ no escrit√≥rio.", "O que me faz questionar minha heterossexualidade?", "A √∫nica coisa que me acalma √© _____.",
        "O presente perfeito para o Dia das M√£es √© _____.", "Por que eu fui demitido do McDonald's?", "O que o Faust√£o guarda na churrasqueira?",
        "A solu√ß√£o para a crise econ√¥mica √© _____.", "Qual √© o superpoder mais in√∫til?", "O que eu disse para o policial quando fui parado?",
        "A Xuxa fez um pacto com _____.", "O que n√£o pode faltar no almo√ßo de domingo?", "Motivo do meu √∫ltimo t√©rmino: _____.",
        "O m√©dico receitou _____ para a minha ansiedade.", "O que a vizinha fofoqueira viu pela janela?", "Harry Potter e o mist√©rio de _____.",
        "O que me impede de ser rico?", "Qual o nome do grupo da fam√≠lia no WhatsApp?", "O que eu faria se fosse invis√≠vel por uma hora?",
        "Deus perdoa, mas _____ n√£o."
    ];

    const whiteCardsData = [
        "Um an√£o bombado.", "O Lula com 10 dedos.", "Tr√°fico de √≥rg√£os.", "Uma cenoura.", "Fingir orgasmo.", "A piroca do Kid Bengala.",
        "Fazer uma chuca mal feita.", "Um golden shower surpresa.", "Bater na av√≥.", "Um teste de gravidez positivo.", "Pablo Mar√ßal num coach.",
        "A gr√°vida de Taubat√©.", "D√≠vida no Serasa.", "Um Fiat Marea Turbo.", "Comer o cu de quem t√° lendo.", "Um cad√°ver fresco.",
        "Pagar pens√£o aliment√≠cia.", "Um travesti de 2 metros.", "Cheirar coca√≠na no pau de um palha√ßo.", "Oito litros de Corote.",
        "Demitir o estagi√°rio.", "Calcinha comest√≠vel sabor bacon.", "Minha dignidade.", "Um peido silencioso e mortal.", "Vender foto do p√©.",
        "O Agostinho Carrara.", "Gemid√£o do Zap.", "Chutar mendigo.", "A harmoniza√ß√£o facial do dem√¥nio.", "Vira-lata caramelo.",
        "Boleto vencido.", "Caf√© frio e cigarro.", "Uma coxinha mordida.", "O v√©io da Havan.", "Um √°udio de 5 minutos da sua m√£e.",
        "Arroz com uva passa.", "Pav√™ ou pacum√™.", "Um Palio 98 rebaixado.", "Churrasco de gato.", "Tr√™s reais de p√£o.",
        "A sand√°lia Havaiana da sua m√£e voando.", "Um PM de folga.", "Dois caras numa moto.", "O filme do Pel√©.", "Uma garrafa pet no rel√≥gio de luz.",
        "Filtro de barro.", "Mendingar like no Instagram.", "Uma Capivara raivosa.", "O Louro Jos√© (Saudades).", "Ana Maria Braga b√™bada.",
        "Silvio Santos jogando avi√£ozinho.", "Um soco na costela.", "Rinha de Galo.", "Jogo do Bicho.", "Sogra de biqu√≠ni.", "Tio do pav√™.",
        "Primo rico que vende Hinode.", "Luva de Pedreiro.", "Bora Bill!", "Caneta Azul.", "Calvo do Campari.", "Um v√≠deo do Felipe Neto.",
        "Banheira de Nutella.", "Podcast de maromba.", "Fake News no grupo da igreja.", "Travar o Zap.", "Um nude vazado.", "A cabeleireira Leila.",
        "Vazar o print.", "Stalkear o ex.", "Webnamoro.", "Jogar Free Fire no banheiro.", "Fazer dancinha no TikTok.", "Reagir com foguinho no story.",
        "Herpes labial.", "Candid√≠ase.", "Viagra vencido.", "Boneca infl√°vel furada.", "Sexo na praia (com areia).", "Mamar no sigilo.",
        "Um vibrador movido a diesel.", "Fetiche em p√©s sujos.", "Suruba na terceira idade.", "Um travesti an√£o.", "Incesto (Game of Thrones style).",
        "Aborto caseiro.", "Necrofilia leve.", "Garganta profunda.", "Cagar de porta aberta.", "Limpar a bunda com lixa.", "Hitler de calcinha.",
        "Jesus Cristo numa moto.", "Um tubar√£o com lasers.", "Falar mal de K-Pop.", "A inexist√™ncia do Acre.", "O Mundial do Palmeiras.",
        "Um ataque de diarreia em p√∫blico.", "Colocar feij√£o embaixo do arroz.", "Pizza de Strogonoff.", "Comer borda de pizza.", "Ketchup na pizza.",
        "Veganos chatos.", "Crossfiteiro.", "Coach qu√¢ntico.", "Bater palmas quando o avi√£o pousa.", "Aplaudir o p√¥r do sol.", "Usar sapat√™nis.",
        "Camisa polo com gola levantada.", "O Patriota do caminh√£o.", "Urach cuspindo na cara.", "In√™s Brasil.", "Gretchen rebolando.",
        "Um gol da Alemanha.", "O menino Neymar caindo.", "Sonegar impostos.", "Orelha do Van Gogh.", "Um rim saud√°vel.", "Vender a alma pro diabo.",
        "Tomar banho de chinelo.", "Secar o saco com secador.", "Depila√ß√£o a cera.", "Um boleto pago.", "A senha da Netflix do vizinho."
    ];

    // --- GAME LOGIC ---

    els.roomCode.innerText = roomCode;

    // 1. Conex√£o e Listeners
    const roomRef = ref(db, `rooms/${roomCode}`);
    
    onValue(roomRef, (snap) => {
        const data = snap.val();
        if(!data) return;

        els.loading.style.display = 'none';

        // Set Host
        if(data.host === myId) isHost = true;
        
        // Set My Info
        if(data.players && data.players[myId]) {
            myName = data.players[myId].name;
            const score = data.players[myId].score_fdp || 0;
            els.score.innerText = score;
        }

        // Render Game State
        if(data.fdp_match) {
            updateInterface(data.fdp_match, data.players);
            
            // HOST: Inicia o jogo se for o primeiro acesso
            if(isHost && data.status === 'redirecting_to_fdp' && !data.fdp_match.currentRound) {
                // Inicia primeiro round
                hostStartNewRound(Object.keys(data.players));
            }
        } else if (isHost) {
            // Se n√£o tem match criado, cria agora
            hostStartNewRound(Object.keys(data.players));
        }
    });

    // 2. Interface Principal
    function updateInterface(matchData, players) {
        const isJudge = (matchData.judgeId === myId);
        const judgeName = players[matchData.judgeId]?.name || "???";
        
        // Cores Din√¢micas
        const colors = ['#0aff60', '#b537f2', '#ff2a6d', '#f5e625'];
        const activeColor = colors[(matchData.roundCount || 0) % colors.length];
        els.ambilight.style.background = `radial-gradient(circle at 50% 30%, ${activeColor}, #000)`;

        els.blackText.innerText = matchData.blackCard;
        els.judgeName.innerText = `PATR√ÉO: ${judgeName}`;
        
        // ESTADO: PICKING (Jogadores escolhendo)
        if(matchData.state === 'PICKING') {
            els.modal.style.display = 'none'; // Esconde modal se tiver aberto
            els.table.innerHTML = ''; // Limpa mesa visualmente
            
            if(isJudge) {
                els.status.innerText = "VOC√ä √â O PATR√ÉO. AGUARDE A GALERA.";
                els.hand.style.display = 'none';
                els.btnAction.classList.remove('visible');
                
                // Mostra cartas "viradas" na mesa
                if(matchData.table) {
                    const count = Object.keys(matchData.table).length;
                    const totalPlayers = Object.keys(players).length - 1;
                    els.status.innerText = `AGUARDANDO (${count}/${totalPlayers} JOGARAM)...`;
                    renderTableHidden(count);
                }
            } else {
                // Jogador
                const myPlay = matchData.table ? matchData.table[myId] : null;
                
                if(myPlay) {
                    els.status.innerText = "RESPOSTA ENVIADA. RELAXE.";
                    els.hand.style.display = 'none';
                    els.btnAction.classList.remove('visible');
                } else {
                    els.status.innerText = "SUA VEZ! ESCOLHA A MELHOR CARTA.";
                    els.hand.style.display = 'flex';
                    // Renderiza m√£o (se n√£o estiver renderizada ou mudou)
                    renderHand(players[myId].hand_fdp || []);
                }
            }
        }
        
        // ESTADO: JUDGING (Patr√£o escolhe)
        else if(matchData.state === 'JUDGING') {
            els.hand.style.display = 'none';
            els.btnAction.classList.remove('visible');
            
            if(isJudge) {
                els.status.innerText = "LEIA EM VOZ ALTA E ESCOLHA A VENCEDORA!";
            } else {
                els.status.innerText = `${judgeName} EST√Å JULGANDO...`;
            }
            
            renderTableRevealed(matchData.table, isJudge);
        }
    }

    // 3. Renderiza√ß√£o da M√£o
    function renderHand(handData) {
        hand = handData || [];
        els.hand.innerHTML = '';
        
        hand.forEach((text, idx) => {
            const div = document.createElement('div');
            div.className = 'hand-card card-white';
            div.innerHTML = text; // Permite HTML se tiver
            div.onclick = () => selectCard(idx, div);
            els.hand.appendChild(div);
        });
        
        // Se m√£o vazia (ex: entrou agora), gera
        if(hand.length === 0) fillHand();
    }

    function selectCard(idx, element) {
        playSound('play');
        document.querySelectorAll('.hand-card').forEach(c => c.classList.remove('selected'));
        element.classList.add('selected');
        selectedCardIdx = idx;
        
        // Show Button
        els.btnAction.innerText = "JOGAR CARTA";
        els.btnAction.onclick = submitCard;
        els.btnAction.classList.add('visible');
    }

    function submitCard() {
        if(selectedCardIdx === -1) return;
        playSound('deal');
        
        const text = hand[selectedCardIdx];
        const newHand = [...hand];
        newHand.splice(selectedCardIdx, 1); // Remove
        
        // Rep√µe carta localmente
        const newCard = getRandomWhite();
        newHand.push(newCard);
        
        // Salva
        update(ref(db, `rooms/${roomCode}/players/${myId}`), { hand_fdp: newHand });
        
        // Envia para mesa
        update(ref(db, `rooms/${roomCode}/fdp_match/table/${myId}`), { 
            text: text, 
            ownerName: myName, 
            ownerId: myId 
        });

        // Trigger Host Check
        triggerCheck();
        
        // UI Imediata
        els.btnAction.classList.remove('visible');
        els.hand.style.display = 'none';
        els.status.innerText = "ENVIANDO...";
    }

    // 4. Renderiza√ß√£o da Mesa
    function renderTableHidden(count) {
        els.table.innerHTML = '';
        for(let i=0; i<count; i++) {
            const div = document.createElement('div');
            div.className = 'fdp-card card-black';
            div.style.justifyContent = 'center'; 
            div.style.alignItems = 'center';
            div.innerHTML = '<i class="fa-solid fa-layer-group fa-2x" style="opacity:0.5;"></i>';
            els.table.appendChild(div);
        }
    }

    function renderTableRevealed(tableData, iAmJudge) {
        els.table.innerHTML = '';
        if(!tableData) return;

        Object.entries(tableData).forEach(([uid, item], idx) => {
            const div = document.createElement('div');
            div.className = 'fdp-card card-white table-card';
            div.innerHTML = item.text;
            div.style.animationDelay = `${idx * 0.1}s`; // Staggered animation
            
            if(iAmJudge) {
                div.onclick = () => confirmWinner(uid, item);
            }
            els.table.appendChild(div);
        });
    }

    function confirmWinner(uid, item) {
        if(confirm(`Escolher "${item.text}" como vencedora?`)) {
            // Anuncia Vencedor
            update(ref(db, `rooms/${roomCode}/fdp_match`), {
                state: 'WINNER',
                winner: {
                    name: item.ownerName,
                    text: item.text,
                    black: els.blackText.innerText
                }
            });
            
            // D√° ponto
            get(ref(db, `rooms/${roomCode}/players/${uid}/score_fdp`)).then(s => {
                const pts = s.val() || 0;
                update(ref(db, `rooms/${roomCode}/players/${uid}`), { score_fdp: pts + 1 });
            });
            
            // Proxima rodada em 5s
            setTimeout(() => {
                get(ref(db, `rooms/${roomCode}/players`)).then(snap => {
                    hostStartNewRound(Object.keys(snap.val()));
                });
            }, 6000);
        }
    }

    // 5. Listener de Vencedor
    onValue(ref(db, `rooms/${roomCode}/fdp_match/winner`), (snap) => {
        const win = snap.val();
        if(win) {
            playSound('win');
            els.winnerName.innerText = win.name;
            els.winnerCard.innerHTML = `
                <div style="font-size:0.75rem; opacity:0.6; margin-bottom:15px; border-bottom:1px solid #ccc; padding-bottom:10px;">${win.black}</div>
                ${win.text}
            `;
            els.modal.style.display = 'flex';
        } else {
            els.modal.style.display = 'none';
        }
    });

    // --- LOGICA DO HOST ---
    async function hostStartNewRound(playersList) {
        if(!isHost) return;
        
        const matchRef = ref(db, `rooms/${roomCode}/fdp_match`);
        const s = await get(matchRef);
        const current = s.val() || { roundCount: 0 };
        
        let nextJudgeIdx = 0;
        if(current.judgeId) {
            const idx = playersList.indexOf(current.judgeId);
            nextJudgeIdx = (idx + 1) % playersList.length;
        }
        
        const nextJudge = playersList[nextJudgeIdx];
        const nextBlack = blackCards[Math.floor(Math.random() * blackCards.length)];
        
        update(matchRef, {
            state: 'PICKING',
            judgeId: nextJudge,
            blackCard: nextBlack,
            table: null,
            winner: null,
            roundCount: (current.roundCount || 0) + 1
        });
        
        update(ref(db, `rooms/${roomCode}`), { status: 'game_fdp' });
    }

    async function triggerCheck() {
        // Chamada por qualquer um, mas s√≥ host executa mudan√ßa de estado
        if(!isHost) return;
        const snap = await get(ref(db, `rooms/${roomCode}`));
        const d = snap.val();
        
        const totalP = Object.keys(d.players).length;
        const played = d.fdp_match.table ? Object.keys(d.fdp_match.table).length : 0;
        
        // Se todos (menos o juiz) jogaram
        if(played >= (totalP - 1) && totalP > 1) {
            update(ref(db, `rooms/${roomCode}/fdp_match`), { state: 'JUDGING' });
        }
    }

    // --- UTILS ---
    function getRandomWhite() {
        return whiteCardsData[Math.floor(Math.random() * whiteCardsData.length)];
    }

    function fillHand() {
        const h = [];
        for(let i=0; i<7; i++) h.push(getRandomWhite());
        update(ref(db, `rooms/${roomCode}/players/${myId}`), { hand_fdp: h });
        hand = h;
    }

    // Inicializa√ß√£o segura
    setTimeout(() => {
        get(ref(db, `rooms/${roomCode}/players/${myId}/hand_fdp`)).then(s => {
            if(!s.exists()) fillHand();
        });
    }, 1500);

</script>
</body>
</html>
