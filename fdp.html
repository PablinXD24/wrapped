<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FDP - Premium Edition</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700;900&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap');

        :root {
            --neon-green: #0aff60;
            --neon-purple: #b537f2;
            --neon-blue: #2d46b9;
            --neon-pink: #ff2a6d;
            --neon-yellow: #f5e625;
            --bg-dark: #050505;
            --card-black: rgba(20, 20, 20, 0.7);
            --card-white: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.15);
            --font-display: 'Space Grotesk', sans-serif;
            --font-data: 'Space Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-dark);
            color: white;
            height: 100vh; width: 100vw; overflow: hidden;
            font-family: var(--font-display);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        /* --- VISUAL EFFECTS --- */
        .noise { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://grainy-gradients.vercel.app/noise.svg'); opacity: 0.04; pointer-events: none; z-index: 999; }
        
        /* Fundo din√¢mico mais suave */
        .ambilight-bg { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; 
            opacity: 0.5; filter: blur(120px); 
            background: radial-gradient(circle at 50% 30%, #333, #000); 
            transition: background 2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-container { 
            position: relative; width: 100%; height: 100%; max-width: 500px; z-index: 10; 
            display: flex; flex-direction: column;
            @media(min-width:768px){ height: 90vh; border: var(--glass-border); border-radius:30px; overflow:hidden; box-shadow: 0 20px 80px rgba(0,0,0,0.6); background: rgba(0,0,0,0.2); backdrop-filter: blur(20px); }
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; padding: 24px;
            overflow-y: auto; scrollbar-width: none;
        }
        .screen.active { display: flex; animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TYPOGRAPHY & UI --- */
        h1 { font-size: 3.5rem; font-weight: 900; line-height: 0.9; letter-spacing: -2px; margin-bottom: 10px; text-transform: uppercase; background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        p { font-size: 1.1rem; color: rgba(255,255,255,0.7); line-height: 1.5; margin-bottom: 30px; font-weight: 300; }

        .btn { 
            background: white; color: black; border: none; padding: 20px; border-radius: 16px; 
            font-family: var(--font-display); font-weight: 800; font-size: 1rem; width: 100%; 
            cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); position: relative; overflow: hidden;
        }
        .btn:active { transform: scale(0.98); }
        .btn:hover { box-shadow: 0 10px 40px rgba(255,255,255,0.3); transform: translateY(-2px); }

        .btn-confirm {
            background: var(--neon-green); 
            box-shadow: 0 0 30px rgba(10, 255, 96, 0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(10, 255, 96, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(10, 255, 96, 0); } 100% { box-shadow: 0 0 0 0 rgba(10, 255, 96, 0); } }

        input { 
            width: 100%; background: rgba(255,255,255,0.05); border: var(--glass-border); 
            color: white; padding: 20px; border-radius: 16px; 
            font-family: var(--font-display); font-weight: 700; font-size: 1.5rem; 
            outline: none; margin-bottom: 30px; text-align: center; 
            text-transform: uppercase; transition: 0.3s;
        }
        input:focus { background: rgba(255,255,255,0.1); border-color: white; box-shadow: 0 0 20px rgba(255,255,255,0.1); }

        /* --- CARDS REIMAGINED --- */
        .fdp-card {
            padding: 24px; border-radius: 20px;
            font-weight: 700; font-size: 1.25rem; line-height: 1.25;
            min-height: 200px; display: flex; flex-direction: column; justify-content: space-between;
            position: relative; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }
        
        .card-black { 
            background: linear-gradient(145deg, rgba(20,20,20,0.8), rgba(10,10,10,0.95)); 
            color: white; border: 1px solid rgba(255,255,255,0.1); 
        }
        .card-black i { font-size: 1.5rem; opacity: 0.3; }

        .card-white { 
            background: linear-gradient(145deg, #ffffff, #e6e6e6); 
            color: #111; border: none; cursor: pointer;
        }
        
        /* M√£o do Jogador (Fan Effect) */
        .hand-scroll { 
            display: flex; gap: 0; padding: 40px 20px; 
            margin-top: auto; margin-left: -20px; margin-right: -20px;
            overflow-x: auto; scrollbar-width: none; 
            perspective: 1000px;
        }
        .hand-card { 
            min-width: 150px; width: 150px; height: 220px; font-size: 1rem; 
            margin-right: -40px; /* Sobreposi√ß√£o */
            transform: rotate(3deg); border: 1px solid rgba(0,0,0,0.1);
            transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .hand-card:last-child { margin-right: 20px; }
        
        .hand-card:hover, .hand-card.selected { 
            transform: translateY(-40px) rotate(0deg) scale(1.1); 
            z-index: 100; margin-right: 10px; margin-left: 10px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        }
        .hand-card.selected { border: 4px solid var(--neon-green); }

        /* Mesa */
        .table-area { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 10px; 
            padding-bottom: 20px;
        }
        .table-card { 
            min-height: 140px; font-size: 0.9rem; animation: popIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards; 
        }
        
        /* Badges e Status */
        .boss-badge { 
            background: var(--neon-purple); color: white; padding: 8px 16px; border-radius: 50px; 
            font-size: 0.75rem; font-weight: 800; letter-spacing: 1px; display: inline-block; 
            margin-bottom: 12px; box-shadow: 0 0 20px var(--neon-purple); border: 1px solid rgba(255,255,255,0.3);
        }
        
        .status-text { 
            font-family: var(--font-data); color: var(--neon-pink); margin-top: 15px; 
            text-transform: uppercase; font-size: 0.8rem; letter-spacing: 2px; font-weight: bold;
            display: flex; align-items: center; gap: 10px;
        }
        .status-dot { width: 8px; height: 8px; background: var(--neon-pink); border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* Placar */
        .score-board { 
            display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; 
            margin-bottom: 20px; scrollbar-width: none;
        }
        .player-chip { 
            background: rgba(255,255,255,0.08); padding: 6px 6px 6px 16px; border-radius: 50px; 
            white-space: nowrap; font-size: 0.8rem; font-weight: bold;
            display: flex; align-items: center; gap: 10px; border: 1px solid rgba(255,255,255,0.05);
            transition: 0.3s;
        }
        .player-chip.active { background: rgba(255,255,255,0.2); border-color: var(--neon-green); box-shadow: 0 0 15px rgba(30, 215, 96, 0.2); }
        .score-circle { 
            width: 30px; height: 30px; background: white; color: black; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-weight: 900; 
        }

        /* Modal */
        .modal-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 200; display: none; justify-content: center; align-items: center; flex-direction: column;
            animation: fadeIn 0.3s;
        }
        @keyframes popIn { from { transform: scale(0.8) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        #loading-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 999; display: flex; justify-content: center; align-items: center; color: white; font-family: var(--font-data); }

        /* Responsividade */
        @media (max-height: 700px) {
            h1 { font-size: 2.5rem; }
            .fdp-card { min-height: 160px; padding: 16px; font-size: 1.1rem; }
            .hand-card { height: 180px; }
        }
    </style>
</head>
<body>

<div id="loading-screen">CONECTANDO...</div>
<div class="noise"></div>
<div class="ambilight-bg" id="ambilight"></div>

<div class="app-container">

    <div id="screen-home" class="screen" style="text-align: center; justify-content: center;">
        <div style="width: 100%;">
            <h1 style="color: var(--neon-pink);">FDP</h1>
            <p style="letter-spacing: 4px; font-family: var(--font-data); font-size: 0.9rem; margin-top: -10px;">PREMIUM EDITION</p>
            <div style="margin: 50px 0;">
                <input type="text" id="manual-room" placeholder="C√ìDIGO DA SALA">
            </div>
            <button class="btn btn-confirm" onclick="window.location.href='fdp.html?room='+document.getElementById('manual-room').value">ENTRAR</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="score-board" id="score-board"></div>

        <div style="flex-shrink: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="boss-indicator" class="boss-badge" style="display:none;"><i class="fa-solid fa-crown"></i> PATR√ÉO DA RODADA</span>
                <span id="boss-name-display" class="boss-badge" style="background: transparent; border:none; box-shadow:none;"></span>
            </div>
            
            <div id="black-card" class="fdp-card card-black">
                <span id="black-text">Carregando...</span>
                <i class="fa-solid fa-masks-theater" style="align-self: flex-end;"></i>
            </div>
            
            <div class="status-text">
                <div class="status-dot"></div>
                <span id="game-status">AGUARDANDO...</span>
            </div>
        </div>

        <div id="table-area" class="table-area" style="display: none;"></div>

        <div id="hand-area" class="hand-scroll"></div>

        <div id="action-area" style="position: absolute; bottom: 30px; left: 0; width: 100%; padding: 0 30px; pointer-events: none; z-index: 150;">
            <button id="btn-confirm" class="btn btn-confirm" style="pointer-events: auto; display: none;" onclick="confirmPlay()">CONFIRMAR ESCOLHA</button>
        </div>
    </div>

    <div id="turn-overlay" class="modal-overlay">
        <h2 style="color: var(--neon-yellow); letter-spacing: 3px; font-size: 1.2rem; margin-bottom: 20px;">VENCEDOR DA RODADA</h2>
        
        <div id="winner-card-display" class="fdp-card card-white" style="transform: rotate(-2deg); margin: 0 20px 40px 20px; width: 85%; max-width: 320px; box-shadow: 0 0 50px rgba(255,255,255,0.2);">
            ...
        </div>
        
        <div id="winner-avatar" style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 3rem; margin-bottom: 10px;">üëë</div>
            <h1 id="winner-name" style="font-size: 2rem; margin: 0;">NOME</h1>
        </div>
        
        <p style="opacity: 0.6; font-family: var(--font-data);">Pr√≥xima rodada em instantes...</p>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, push, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    /* --- CONFIGURA√á√ÉO FIREBASE --- */
    const firebaseConfig = {
        apiKey: "AIzaSyB1buacNarLY8ELWla6yeqTi4L0vTdloSc",
        authDomain: "wrapped-fad94.firebaseapp.com",
        databaseURL: "https://wrapped-fad94-default-rtdb.firebaseio.com",
        projectId: "wrapped-fad94",
        storageBucket: "wrapped-fad94.firebasestorage.app",
        messagingSenderId: "360236097664",
        appId: "1:360236097664:web:76777f529c18623bf1c665"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* --- DATABASE COMPLETA DE CARTAS --- */
    const blackCards = [
        "Para fazer amor gostoso, eu preciso de _____.", "O que o Bolsonaro esconde no cofre?", 
        "Minha m√£e chorou quando viu _____.", "Brasileiro gosta mesmo √© de _____.",
        "O novo sabor de Doritos √©: _____.", "A causa da minha morte ser√° _____.",
        "Em briga de marido e mulher, ningu√©m mete _____.", "O que a Anitta vai lan√ßar no pr√≥ximo clipe?",
        "No meu vel√≥rio, eu quero que sirvam _____.", "O verdadeiro motivo do fim do mundo √© _____.",
        "O que eu encontrei no hist√≥rico do navegador do meu pai?", "A nova pol√≠tica da empresa pro√≠be _____.",
        "O que me faz questionar minha heterossexualidade?", "A √∫nica coisa que me acalma √© _____.",
        "Por que eu fui demitido do McDonald's?", "O que o Faust√£o guarda na churrasqueira?",
        "O m√©dico receitou _____ para a minha ansiedade.", "Deus perdoa, mas _____ n√£o.",
        "Qual √© o cheiro do transporte p√∫blico √†s 18h?", "O Brasil s√≥ vai para frente quando liberarem _____.",
        "Qual o nome do grupo da fam√≠lia no WhatsApp?", "Harry Potter e o mist√©rio de _____."
    ];
    
    const whiteCardsData = [
        "Um an√£o bombado.", "O Lula com 10 dedos.", "Tr√°fico de √≥rg√£os.", "Uma cenoura.",
        "Fingir orgasmo.", "A piroca do Kid Bengala.", "Fazer uma chuca mal feita.", "Um golden shower surpresa.",
        "Bater na av√≥.", "Um teste de gravidez positivo.", "Pablo Mar√ßal.", "A gr√°vida de Taubat√©.",
        "D√≠vida no Serasa.", "Um Fiat Marea Turbo.", "Comer o cu de quem t√° lendo.", "Um cad√°ver fresco.",
        "Pagar pens√£o aliment√≠cia.", "Um travesti de 2 metros.", "Cheirar coca√≠na no pau de um palha√ßo.",
        "Oito litros de Corote.", "Demitir o estagi√°rio.", "Calcinha comest√≠vel sabor bacon.", "Minha dignidade.",
        "Um peido silencioso e mortal.", "Vender foto do p√©.", "O Agostinho Carrara.", "Gemid√£o do Zap.",
        "Chutar mendigo.", "A harmoniza√ß√£o facial do demonio.", "Vira-lata caramelo.", "Boleto vencido.",
        "Caf√© frio e cigarro.", "Uma coxinha mordida.", "O v√©io da Havan.", "Um √°udio de 5 minutos da sua m√£e.",
        "Arroz com uva passa.", "Pav√™ ou pacum√™.", "Dois caras numa moto.", "O filme do Pel√©."
    ];

    /* --- VARI√ÅVEIS DO JOGO --- */
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');
    const myId = localStorage.getItem('wrapped_uid');
    
    let myName = "Eu";
    let isHost = false;
    let selectedCardIdx = -1;
    let hand = [];
    
    // Verifica conex√£o
    if(roomCode && myId) {
        document.getElementById('screen-home').style.display = 'none';
        showScreen('screen-game');
    } else {
        document.getElementById('loading-screen').style.display = 'none';
        showScreen('screen-home');
    }

    const roomRef = ref(db, `rooms/${roomCode}`);

    /* --- LISTENER PRINCIPAL (Sincronia Firebase) --- */
    if(roomCode) {
        onValue(roomRef, (snap) => {
            const data = snap.val();
            document.getElementById('loading-screen').style.display = 'none';
            if(!data) return;

            // Identifica√ß√£o
            if(data.host === myId) isHost = true;
            if(data.players && data.players[myId]) {
                myName = data.players[myId].name;
            }

            // Atualiza Interface baseado no estado
            if(data.fdp_match) {
                updateInterface(data.fdp_match, data.players);
            } else if(isHost) {
                // Se o match ainda n√£o existe, host cria
                hostStartNewRound(Object.keys(data.players));
            }
        });
        
        // Listener de Vencedor Separado
        onValue(ref(db, `rooms/${roomCode}/fdp_match/winner`), (snap) => {
            const winData = snap.val();
            const overlay = document.getElementById('turn-overlay');
            if(winData) {
                document.getElementById('winner-name').innerText = winData.name;
                document.getElementById('winner-card-display').innerHTML = `
                    <div style="font-size:0.8rem; opacity:0.6; margin-bottom:10px; border-bottom:1px solid #ccc; padding-bottom:5px;">${winData.black}</div>
                    ${winData.text}
                `;
                overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none';
            }
        });

        // Listener de M√£o (Individual)
        onValue(ref(db, `rooms/${roomCode}/players/${myId}/hand_fdp`), (snap) => {
            if(snap.exists()) {
                hand = snap.val();
                // A renderiza√ß√£o da m√£o acontece dentro do updateInterface se for o estado correto
                if(document.getElementById('hand-area').style.display !== 'none') {
                    renderHand(hand);
                }
            } else {
                fillHand(); // Gera m√£o inicial se n√£o tiver
            }
        });
    }

    /* --- ATUALIZA√á√ÉO DA INTERFACE --- */
    function updateInterface(matchData, players) {
        const isJudge = (matchData.judgeId === myId);
        const judgeName = players[matchData.judgeId]?.name || "???";

        // Cores Din√¢micas
        const colors = ['#0aff60', '#b537f2', '#ff2a6d', '#f5e625'];
        const activeColor = colors[(matchData.roundCount || 0) % colors.length];
        document.getElementById('ambilight').style.background = `radial-gradient(circle at 50% 30%, ${activeColor}, #000)`;

        // Atualiza Carta Preta e Juiz
        document.getElementById('black-text').innerText = matchData.blackCard;
        
        // Atualiza Placar (Top Bar)
        updateScoreBoard(players, matchData.judgeId);

        // ESTADO 1: JOGADORES ESCOLHENDO
        if(matchData.state === 'PICKING') {
            document.getElementById('table-area').innerHTML = '';
            document.getElementById('table-area').style.display = 'none';
            document.getElementById('turn-overlay').style.display = 'none'; // Garante que overlay sumiu
            
            if(isJudge) {
                document.getElementById('boss-indicator').style.display = 'inline-block';
                document.getElementById('boss-name-display').style.display = 'none';
                document.getElementById('game-status').innerText = "VOC√ä √â O PATR√ÉO. AGUARDE...";
                document.getElementById('hand-area').style.display = 'none';
                document.getElementById('btn-confirm').style.display = 'none';
                
                // Mostra progresso
                if(matchData.table) {
                    const count = Object.keys(matchData.table).length;
                    document.getElementById('game-status').innerText = `AGUARDANDO (${count} JOGARAM)...`;
                    // Renderiza mesa oculta pro juiz ver que est√£o jogando
                    document.getElementById('table-area').style.display = 'grid';
                    renderTableHidden(count);
                }
            } else {
                // Jogador Normal
                document.getElementById('boss-indicator').style.display = 'none';
                document.getElementById('boss-name-display').style.display = 'inline-block';
                document.getElementById('boss-name-display').innerHTML = `<i class="fa-solid fa-gavel"></i> Patr√£o: ${judgeName}`;
                
                const myPlay = matchData.table ? matchData.table[myId] : null;
                if(myPlay) {
                    document.getElementById('game-status').innerText = "RESPOSTA ENVIADA.";
                    document.getElementById('hand-area').style.display = 'none';
                    document.getElementById('btn-confirm').style.display = 'none';
                } else {
                    document.getElementById('game-status').innerText = "SUA VEZ! ESCOLHA A MELHOR CARTA.";
                    document.getElementById('hand-area').style.display = 'flex';
                    renderHand(hand); // Garante que a m√£o est√° vis√≠vel
                }
            }
        }
        
        // ESTADO 2: JULGAMENTO (REVELA√á√ÉO)
        else if (matchData.state === 'JUDGING') {
            document.getElementById('hand-area').style.display = 'none';
            document.getElementById('btn-confirm').style.display = 'none';
            document.getElementById('table-area').style.display = 'grid';
            
            if(isJudge) {
                document.getElementById('game-status').innerText = "ESCOLHA A CARTA VENCEDORA!";
            } else {
                document.getElementById('game-status').innerText = `${judgeName} EST√Å JULGANDO...`;
            }
            
            // S√≥ renderiza a mesa revelada se mudou o estado ou dados
            renderTableRevealed(matchData.table, isJudge);
        }
    }

    /* --- RENDERIZADORES --- */
    function renderHand(handData) {
        const container = document.getElementById('hand-area');
        // Evita re-renderizar se n√£o mudou (opcional, mas aqui fazemos full replace pela simplicidade)
        container.innerHTML = '';
        
        handData.forEach((text, idx) => {
            const card = document.createElement('div');
            card.className = 'fdp-card card-white hand-card';
            card.innerHTML = text;
            card.onclick = () => selectCard(idx, card);
            container.appendChild(card);
        });
    }

    function selectCard(idx, el) {
        document.querySelectorAll('.hand-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        selectedCardIdx = idx;
        
        // Scroll e Bot√£o
        el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        const btn = document.getElementById('btn-confirm');
        btn.style.display = 'block';
        btn.innerText = "JOGAR CARTA";
        btn.onclick = submitCard;
    }

    function submitCard() {
        if(selectedCardIdx === -1) return;
        const text = hand[selectedCardIdx];
        
        // Remove da m√£o localmente e rep√µe
        const newHand = [...hand];
        newHand.splice(selectedCardIdx, 1);
        newHand.push(whiteCardsData[Math.floor(Math.random() * whiteCardsData.length)]);
        
        // Salva m√£o nova
        update(ref(db, `rooms/${roomCode}/players/${myId}`), { hand_fdp: newHand });
        
        // Envia carta pra mesa
        update(ref(db, `rooms/${roomCode}/fdp_match/table/${myId}`), { 
            text: text, 
            ownerName: myName, 
            ownerId: myId 
        });

        // UI Update imediato
        document.getElementById('hand-area').style.display = 'none';
        document.getElementById('btn-confirm').style.display = 'none';
        document.getElementById('game-status').innerText = "ENVIANDO...";

        // Trigger Host Check
        hostCheckAllPlayed();
    }

    function renderTableHidden(count) {
        const container = document.getElementById('table-area');
        container.innerHTML = '';
        for(let i=0; i<count; i++) {
            const div = document.createElement('div');
            div.className = 'fdp-card card-black';
            div.style.justifyContent = 'center'; align-items: 'center';
            div.innerHTML = '<i class="fa-solid fa-layer-group fa-2x"></i>';
            container.appendChild(div);
        }
    }

    function renderTableRevealed(tableData, iAmJudge) {
        const container = document.getElementById('table-area');
        container.innerHTML = '';
        if(!tableData) return;

        Object.entries(tableData).forEach(([uid, item], idx) => {
            const div = document.createElement('div');
            div.className = 'fdp-card card-white table-card';
            div.innerHTML = item.text;
            div.style.animationDelay = `${idx * 0.1}s`; // Staggered animation
            
            if(iAmJudge) {
                div.onclick = () => selectWinner(uid, item, div);
            }
            container.appendChild(div);
        });
    }

    function selectWinner(uid, item, el) {
        document.querySelectorAll('.table-card').forEach(c => {
            c.style.opacity = '0.4'; c.style.transform = 'scale(0.95)';
        });
        el.style.opacity = '1'; el.style.transform = 'scale(1.05)';
        
        const btn = document.getElementById('btn-confirm');
        btn.style.display = 'block';
        btn.innerText = "CONFIRMAR VENCEDOR";
        btn.onclick = () => confirmWinner(uid, item);
    }

    function confirmWinner(uid, item) {
        if(confirm(`Vencedor: "${item.text}"?`)) {
            // Define Vencedor
            update(ref(db, `rooms/${roomCode}/fdp_match`), {
                state: 'WINNER',
                winner: { name: item.ownerName, text: item.text, black: document.getElementById('black-text').innerText }
            });
            
            // D√° ponto
            get(ref(db, `rooms/${roomCode}/players/${uid}/score_fdp`)).then(s => {
                const pts = s.val() || 0;
                update(ref(db, `rooms/${roomCode}/players/${uid}`), { score_fdp: pts + 1 });
            });

            // Pr√≥ximo round em 5s
            setTimeout(() => {
                get(ref(db, `rooms/${roomCode}/players`)).then(snap => {
                    hostStartNewRound(Object.keys(snap.val()));
                });
            }, 6000);
        }
    }

    function updateScoreBoard(players, judgeId) {
        const board = document.getElementById('score-board');
        board.innerHTML = '';
        if(!players) return;
        
        Object.values(players).forEach(p => {
            const isJudge = (p.id === judgeId); // Se tiver ID no objeto player
            // Como players √© objeto indexado por ID, precisamos iterar entries pra saber o ID se n√£o estiver salvo dentro
            // Mas no wrapped salvamos key como ID. Vamos assumir que conseguimos comparar.
            
            const score = p.score_fdp || 0;
            const chip = document.createElement('div');
            chip.className = `player-chip`; // Adicionar active se for juiz √© complexo sem iterar keys, simplificando:
            if(p.name === document.getElementById('judge-name').innerText.replace('PATR√ÉO: ', '')) {
                chip.classList.add('active');
            }
            
            chip.innerHTML = `<span>${p.name}</span><div class="score-circle">${score}</div>`;
            board.appendChild(chip);
        });
    }

    /* --- L√ìGICA DO HOST --- */
    async function hostStartNewRound(playerIds) {
        if(!isHost) return;
        const matchRef = ref(db, `rooms/${roomCode}/fdp_match`);
        const s = await get(matchRef);
        const current = s.val() || { roundCount: 0 };
        
        let nextJudgeIdx = 0;
        if(current.judgeId) {
            const idx = playerIds.indexOf(current.judgeId);
            nextJudgeIdx = (idx + 1) % playerIds.length;
        }
        
        const nextJudge = playerIds[nextJudgeIdx];
        const nextBlack = blackCards[Math.floor(Math.random() * blackCards.length)];
        
        update(matchRef, {
            state: 'PICKING',
            judgeId: nextJudge,
            blackCard: nextBlack,
            table: null,
            winner: null,
            roundCount: (current.roundCount || 0) + 1
        });
        
        // Garante status global
        update(ref(db, `rooms/${roomCode}`), { status: 'game_fdp' });
    }

    async function hostCheckAllPlayed() {
        if(!isHost) return;
        const snap = await get(ref(db, `rooms/${roomCode}`));
        const data = snap.val();
        
        const totalP = Object.keys(data.players).length;
        const played = data.fdp_match.table ? Object.keys(data.fdp_match.table).length : 0;
        
        if(played >= (totalP - 1) && totalP > 1) {
            update(ref(db, `rooms/${roomCode}/fdp_match`), { state: 'JUDGING' });
        }
    }

    function fillHand() {
        const h = [];
        for(let i=0; i<7; i++) h.push(whiteCardsData[Math.floor(Math.random() * whiteCardsData.length)]);
        update(ref(db, `rooms/${roomCode}/players/${myId}`), { hand_fdp: h });
        hand = h;
    }
    
    // Fun√ß√µes auxiliares de navega√ß√£o
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.style.display = 'none'; });
        const target = document.getElementById(id);
        target.style.display = 'flex';
        setTimeout(() => target.classList.add('active'), 10);
    }
    
    // Fallback para nextRound se o bot√£o for clicado (apenas visual, host controla tempo real)
    window.nextRound = function() {
        document.getElementById('turn-overlay').style.display = 'none';
    }
    
    window.confirmPlay = function() {
        // Fun√ß√£o placeholder para o HTML chamar, a l√≥gica real √© definida dinamicamente no onclick
    }
    
</script>
</body>
</html>
