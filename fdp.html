<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FDP - Democracy Mode</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700;900&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap');

        :root {
            --neon-green: #0aff60;
            --neon-purple: #b537f2;
            --neon-blue: #2d46b9;
            --neon-pink: #ff2a6d;
            --neon-yellow: #f5e625;
            --bg-dark: #050505;
            --card-black: rgba(20, 20, 20, 0.9);
            --card-white: rgba(255, 255, 255, 0.95);
            --font-display: 'Space Grotesk', sans-serif;
            --font-data: 'Space Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-dark);
            color: white;
            height: 100vh; width: 100vw; overflow: hidden;
            font-family: var(--font-display);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        /* --- VISUAL FX --- */
        .noise { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://grainy-gradients.vercel.app/noise.svg'); opacity: 0.04; pointer-events: none; z-index: 999; }
        .ambilight-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.5; filter: blur(120px); background: radial-gradient(circle at 50% 30%, #333, #000); transition: background 2s ease; }

        .app-container { 
            position: relative; width: 100%; height: 100%; max-width: 500px; z-index: 10; 
            display: flex; flex-direction: column;
            @media(min-width:768px){ height: 90vh; border: 1px solid rgba(255,255,255,0.1); border-radius:30px; overflow:hidden; box-shadow: 0 20px 80px rgba(0,0,0,0.6); background: rgba(0,0,0,0.2); backdrop-filter: blur(20px); }
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; padding: 24px;
            overflow-y: auto; scrollbar-width: none;
        }
        .screen.active { display: flex; animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI COMPONENTS --- */
        .fdp-card {
            padding: 24px; border-radius: 20px; font-weight: 700; font-size: 1.2rem; line-height: 1.3;
            min-height: 180px; display: flex; flex-direction: column; justify-content: space-between;
            position: relative; transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .card-black { background: var(--card-black); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .card-white { background: var(--card-white); color: #111; border: none; cursor: pointer; }
        
        /* Table Area */
        .table-area { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            padding: 10px 0; overflow-y: auto; align-content: start; flex-grow: 1;
        }
        .table-card { 
            min-height: 140px; font-size: 0.9rem; animation: popIn 0.4s backwards; position: relative;
        }
        .vote-badge {
            position: absolute; top: -10px; right: -10px; background: var(--neon-pink); color: white;
            width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-family: var(--font-data); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: popIn 0.3s; z-index: 10;
        }

        /* Hand Area */
        .hand-scroll { 
            display: flex; gap: 0; height: 240px; flex-shrink: 0;
            overflow-x: auto; scrollbar-width: none; perspective: 1000px;
            margin: 0 -20px; padding: 20px 30px;
        }
        .hand-card { 
            min-width: 140px; width: 140px; height: 200px; font-size: 0.9rem; 
            margin-right: -50px; transform: rotate(4deg); border: 1px solid rgba(0,0,0,0.1);
            transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }
        .hand-card:hover, .hand-card.selected { 
            transform: translateY(-40px) rotate(0deg) scale(1.1); 
            z-index: 100; margin-right: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }
        .hand-card.selected { border: 4px solid var(--neon-green); }

        /* Buttons & Status */
        .status-container { text-align: center; margin: 10px 0; }
        .status-msg { color: var(--neon-pink); font-family: var(--font-data); font-size: 0.8rem; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }

        .btn { 
            background: var(--neon-green); color: black; border: none; padding: 18px; 
            border-radius: 50px; font-weight: 800; font-size: 1rem; width: 100%; 
            text-transform: uppercase; cursor: pointer; box-shadow: 0 0 30px rgba(10, 255, 96, 0.4); 
            transition: 0.3s;
        }
        .btn:active { transform: scale(0.95); }

        .score-board { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; scrollbar-width: none; }
        .player-chip { 
            background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 30px; 
            white-space: nowrap; font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; gap: 8px;
        }
        .score-val { background: white; color: black; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }

        /* Modals */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 200; display: none; 
            flex-direction: column; justify-content: center; align-items: center; 
            padding: 30px; text-align: center; backdrop-filter: blur(10px);
        }
        .win-screen { background: var(--neon-green); color: black; }
        
        .host-force-btn {
            position: absolute; top: 10px; right: 10px; background: rgba(255,0,0,0.2); 
            color: rgba(255,255,255,0.5); font-size: 0.6rem; padding: 5px 10px; border: 1px solid rgba(255,0,0,0.3);
            border-radius: 5px; cursor: pointer; z-index: 9999; display: none;
        }
        
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        
        #loading { position: fixed; inset:0; background:black; z-index:999; display:flex; justify-content:center; align-items:center; color:white; font-family:var(--font-data); }
        .screen { display: none; flex-direction: column; padding: 24px; height: 100%; }
    </style>
</head>
<body>

<div id="loading">CONECTANDO...</div>
<div class="noise"></div>
<div class="ambilight-bg" id="ambilight"></div>

<button id="btn-force" class="host-force-btn" onclick="forceNextPhase()">笞 FORﾃ②R AVANﾃ⑯</button>

<div class="app-container">

    <div id="screen-game" class="screen" style="display: flex;">
        <div class="score-board" id="score-board"></div>

        <div style="flex-shrink: 0;">
            <div class="status-container"><span id="game-status" class="status-msg">...</span></div>
            <div id="black-card" class="fdp-card card-black">
                <span id="black-text">Carregando pergunta...</span>
                <i class="fa-solid fa-masks-theater" style="align-self: flex-end; opacity: 0.5;"></i>
            </div>
        </div>

        <div id="table-area" class="table-area"></div>

        <div id="hand-area" class="hand-scroll"></div>

        <div style="position: absolute; bottom: 30px; left: 0; width: 100%; padding: 0 30px; z-index: 150; pointer-events: none;">
            <button id="btn-action" class="btn" style="pointer-events: auto; display: none;">Aﾃﾃグ</button>
        </div>
    </div>

    <div id="winner-modal" class="modal">
        <h2 style="color: var(--neon-yellow); margin-bottom: 20px; letter-spacing: 2px;">VENCEDOR DA RODADA</h2>
        
        <div id="winner-card-display" class="fdp-card card-white" style="transform: rotate(-2deg); margin: 0 20px 40px 20px; width: 90%; max-width: 320px; color: black;">
            </div>
        
        <div style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px;">JOGADA POR:</div>
        <h1 id="winner-name" style="font-size: 2.5rem; color: white; margin: 0;">PLAYER</h1>
        
        <p style="margin-top:40px; opacity:0.7; font-family:var(--font-data);">Prﾃｳxima rodada em 6s...</p>
    </div>

    <div id="game-over-modal" class="modal win-screen">
        <h1 style="font-size: 5rem; margin-bottom: 10px;">醇</h1>
        <h1 style="font-size: 3rem; margin-bottom: 20px; line-height: 1; font-weight: 900;">CAMPEﾃグ<br>SUPREMO</h1>
        <h2 id="champion-name" style="font-size: 2.5rem; background: black; color: white; padding: 15px 40px; border-radius: 50px;">NOME</h2>
        <p style="margin-top: 30px; font-weight: bold; font-family: var(--font-data);">CHEGOU A 5 PONTOS!</p>
        <button class="btn" style="background: black; color: white; margin-top: 50px;" onclick="location.reload()">NOVO JOGO</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, push, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    /* --- CONFIGURAﾃﾃグ --- */
    const firebaseConfig = {
        apiKey: "AIzaSyB1buacNarLY8ELWla6yeqTi4L0vTdloSc",
        authDomain: "wrapped-fad94.firebaseapp.com",
        databaseURL: "https://wrapped-fad94-default-rtdb.firebaseio.com",
        projectId: "wrapped-fad94",
        storageBucket: "wrapped-fad94.firebasestorage.app",
        messagingSenderId: "360236097664",
        appId: "1:360236097664:web:76777f529c18623bf1c665"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');
    const myId = localStorage.getItem('wrapped_uid');
    
    if(!roomCode || !myId) { alert("Erro de acesso. Entre pelo Wrapped."); window.location.href='index.html'; }

    let myName = "Eu";
    let isHost = false;
    let hand = [];
    let selectedCardIdx = -1;
    let gameOver = false;

    // EXPONDO FUNﾃﾃグ GLOBAL PARA O BOTﾃグ DE EMERGﾃ劾CIA
    window.forceNextPhase = function() {
        if(!isHost) return;
        get(ref(db, `rooms/${roomCode}/fdp_match/state`)).then(s => {
            const st = s.val();
            if(st === 'PICKING') update(ref(db, `rooms/${roomCode}/fdp_match`), { state: 'VOTING' });
            if(st === 'VOTING') {
                // Se travar na votaﾃｧﾃ｣o, forﾃｧa um vencedor aleatﾃｳrio
                get(ref(db, `rooms/${roomCode}/fdp_match/table`)).then(t => {
                    if(t.exists()) {
                        const entries = Object.entries(t.val());
                        const random = entries[Math.floor(Math.random() * entries.length)];
                        const black = document.getElementById('black-text').innerText;
                        
                        update(ref(db, `rooms/${roomCode}/fdp_match`), {
                            state: 'WINNER',
                            winner: { name: random[1].ownerName, text: random[1].text, black: black }
                        });
                        
                        setTimeout(() => hostStartNewRoundClean(), 6000);
                    }
                });
            }
        });
    }

    /* --- DATABASE --- */
    const blackCards = [
        "Para fazer amor gostoso, eu preciso de _____.", "O que o Bolsonaro esconde no cofre?", "Minha mﾃ｣e chorou quando viu _____.",
        "Qual ﾃｩ o segredo para uma vida feliz?", "O que deu errado na minha vida sexual?", "Brasileiro gosta mesmo ﾃｩ de _____.",
        "Em um mundo perfeito, nﾃ｣o existiria _____.", "O novo sabor de Doritos ﾃｩ: _____.", "A causa da minha morte serﾃ｡ _____.",
        "O que eu trouxe da minha viagem ao Paraguai?", "Desculpe, professor, nﾃ｣o fiz o dever porque estava ocupado com _____.",
        "O que o Padre Marcelo Rossi toma no cafﾃｩ da manhﾃ｣?", "Qual ﾃｩ o cheiro do transporte pﾃｺblico ﾃs 18h?",
        "O Brasil sﾃｳ vai para frente quando liberarem _____.", "Em briga de marido e mulher, ninguﾃｩm mete _____.",
        "O que a Anitta vai lanﾃｧar no prﾃｳximo clipe?", "No meu velﾃｳrio, eu quero que sirvam _____.", "Minha fantasia de carnaval esse ano ﾃｩ _____.",
        "O que eu faria por um iPhone 15?", "O verdadeiro motivo do fim do mundo ﾃｩ _____.", "O que eu encontrei no histﾃｳrico do navegador do meu pai?",
        "A nova polﾃｭtica da empresa proﾃｭbe _____ no escritﾃｳrio.", "O que me faz questionar minha heterossexualidade?", "A ﾃｺnica coisa que me acalma ﾃｩ _____.",
        "O presente perfeito para o Dia das Mﾃ｣es ﾃｩ _____.", "Por que eu fui demitido do McDonald's?", "O que o Faustﾃ｣o guarda na churrasqueira?",
        "A soluﾃｧﾃ｣o para a crise econﾃｴmica ﾃｩ _____.", "Qual ﾃｩ o superpoder mais inﾃｺtil?", "O que eu disse para o policial quando fui parado?",
        "A Xuxa fez um pacto com _____.", "O que nﾃ｣o pode faltar no almoﾃｧo de domingo?", "Motivo do meu ﾃｺltimo tﾃｩrmino: _____.",
        "O mﾃｩdico receitou _____ para a minha ansiedade.", "O que a vizinha fofoqueira viu pela janela?", "Harry Potter e o mistﾃｩrio de _____.",
        "O que me impede de ser rico?", "Qual o nome do grupo da famﾃｭlia no WhatsApp?", "O que eu faria se fosse invisﾃｭvel por uma hora?",
        "Deus perdoa, mas _____ nﾃ｣o."
    ];
    const whiteCardsData = [
        "Um anﾃ｣o bombado.", "O Lula com 10 dedos.", "Trﾃ｡fico de ﾃｳrgﾃ｣os.", "Uma cenoura.", "Fingir orgasmo.", "A piroca do Kid Bengala.",
        "Fazer uma chuca mal feita.", "Um golden shower surpresa.", "Bater na avﾃｳ.", "Um teste de gravidez positivo.", "Pablo Marﾃｧal num coach.",
        "A grﾃ｡vida de Taubatﾃｩ.", "Dﾃｭvida no Serasa.", "Um Fiat Marea Turbo.", "Comer o cu de quem tﾃ｡ lendo.", "Um cadﾃ｡ver fresco.",
        "Pagar pensﾃ｣o alimentﾃｭcia.", "Um travesti de 2 metros.", "Cheirar cocaﾃｭna no pau de um palhaﾃｧo.", "Oito litros de Corote.",
        "Demitir o estagiﾃ｡rio.", "Calcinha comestﾃｭvel sabor bacon.", "Minha dignidade.", "Um peido silencioso e mortal.", "Vender foto do pﾃｩ.",
        "O Agostinho Carrara.", "Gemidﾃ｣o do Zap.", "Chutar mendigo.", "A harmonizaﾃｧﾃ｣o facial do demonio.", "Vira-lata caramelo.",
        "Boleto vencido.", "Cafﾃｩ frio e cigarro.", "Uma coxinha mordida.", "O vﾃｩio da Havan.", "Um ﾃ｡udio de 5 minutos da sua mﾃ｣e.",
        "Arroz com uva passa.", "Pavﾃｪ ou pacumﾃｪ.", "Um Palio 98 rebaixado.", "Churrasco de gato.", "Trﾃｪs reais de pﾃ｣o.",
        "A sandﾃ｡lia Havaiana da sua mﾃ｣e voando.", "Um PM de folga.", "Dois caras numa moto.", "O filme do Pelﾃｩ.", "Uma garrafa pet no relﾃｳgio de luz.",
        "Filtro de barro.", "Mendingar like no Instagram.", "Uma Capivara raivosa.", "O Louro Josﾃｩ (Saudades).", "Ana Maria Braga bﾃｪbada.",
        "Silvio Santos jogando aviﾃ｣ozinho.", "Um soco na costela.", "Rinha de Galo.", "Jogo do Bicho.", "Sogra de biquﾃｭni.", "Tio do pavﾃｪ.",
        "Primo rico que vende Hinode.", "Luva de Pedreiro.", "Bora Bill!", "Caneta Azul.", "Calvo do Campari.", "Um vﾃｭdeo do Felipe Neto.",
        "Banheira de Nutella.", "Podcast de maromba.", "Fake News no grupo da igreja.", "Travar o Zap.", "Um nude vazado.", "A cabeleireira Leila.",
        "Vazar o print.", "Stalkear o ex.", "Webnamoro.", "Jogar Free Fire no banheiro.", "Fazer dancinha no TikTok.", "Reagir com foguinho no story.",
        "Herpes labial.", "Candidﾃｭase.", "Viagra vencido.", "Boneca inflﾃ｡vel furada.", "Sexo na praia (com areia).", "Mamar no sigilo.",
        "Um vibrador movido a diesel.", "Fetiche em pﾃｩs sujos.", "Suruba na terceira idade.", "Um travesti anﾃ｣o.", "Incesto (Game of Thrones style).",
        "Aborto caseiro.", "Necrofilia leve.", "Garganta profunda.", "Cagar de porta aberta.", "Limpar a bunda com lixa.", "Hitler de calcinha.",
        "Jesus Cristo numa moto.", "Um tubarﾃ｣o com lasers.", "Falar mal de K-Pop.", "A inexistﾃｪncia do Acre.", "O Mundial do Palmeiras.",
        "Um ataque de diarreia em pﾃｺblico.", "Colocar feijﾃ｣o embaixo do arroz.", "Pizza de Strogonoff.", "Comer borda de pizza.", "Ketchup na pizza.",
        "Veganos chatos.", "Crossfiteiro.", "Coach quﾃ｢ntico.", "Bater palmas quando o aviﾃ｣o pousa.", "Aplaudir o pﾃｴr do sol.", "Usar sapatﾃｪnis.",
        "Camisa polo com gola levantada.", "O Patriota do caminhﾃ｣o.", "Urach cuspindo na cara.", "Inﾃｪs Brasil.", "Gretchen rebolando.",
        "Um gol da Alemanha.", "O menino Neymar caindo.", "Sonegar impostos.", "Orelha do Van Gogh.", "Um rim saudﾃ｡vel.", "Vender a alma pro diabo.",
        "Tomar banho de chinelo.", "Secar o saco com secador.", "Depilaﾃｧﾃ｣o a cera.", "Um boleto pago.", "A senha da Netflix do vizinho."
    ];

    /* --- GAME CONNECT --- */
    const roomRef = ref(db, `rooms/${roomCode}`);
    
    // Inicializar e mostrar a tela correta
    document.getElementById('screen-game').classList.add('active');
    document.getElementById('screen-game').style.display = 'flex';

    const els = {
        loading: document.getElementById('loading'),
        scoreBoard: document.getElementById('score-board'),
        status: document.getElementById('game-status'),
        blackText: document.getElementById('black-text'),
        table: document.getElementById('table-area'),
        hand: document.getElementById('hand-area'),
        btnAction: document.getElementById('btn-action'),
        modalWinner: document.getElementById('winner-modal'),
        modalGameover: document.getElementById('game-over-modal'),
        ambilight: document.getElementById('ambilight'),
        forceBtn: document.getElementById('btn-force')
    };

    onValue(roomRef, (snap) => {
        const data = snap.val();
        els.loading.style.display = 'none';
        if(!data) return;

        if(data.host === myId) {
            isHost = true;
            els.forceBtn.style.display = 'block'; // Mostra botﾃ｣o de emergﾃｪncia
        }
        if(data.players && data.players[myId]) myName = data.players[myId].name;

        // Atualizar Placar
        updateScoreBoard(data.players);
        
        // Checar Fim de Jogo
        checkGameOver(data.players);

        // Lﾃｳgica do Round
        if(!gameOver) {
            if(data.fdp_match) {
                updateInterface(data.fdp_match);
                // REACTIVE HOST LOGIC: Checks every time data changes
                if(isHost) checkRoundProgress(data);
            } else if (isHost) {
                hostStartNewRound();
            }
        }
    });

    /* --- HOST REACTIVE LOGIC (O CORAﾃﾃグ DA CORREﾃﾃグ) --- */
    function checkRoundProgress(data) {
        if(!data.fdp_match) return;
        
        const state = data.fdp_match.state;
        const totalPlayers = Object.keys(data.players).length;
        
        // CHECK FASE DE ESCOLHA (TODOS JOGARAM?)
        if(state === 'PICKING') {
            const playedCount = data.fdp_match.table ? Object.keys(data.fdp_match.table).length : 0;
            // Se todos jogaram, avanﾃｧa para votaﾃｧﾃ｣o
            if(playedCount >= totalPlayers && totalPlayers > 0) {
                update(ref(db, `rooms/${roomCode}/fdp_match`), { state: 'VOTING' });
            }
        }
        
        // CHECK FASE DE VOTAﾃﾃグ (TODOS VOTARAM?)
        if(state === 'VOTING') {
            const votesCount = data.fdp_match.votes ? Object.keys(data.fdp_match.votes).length : 0;
            // Se todos votaram, finaliza round
            if(votesCount >= totalPlayers && totalPlayers > 0) {
                hostFinalizeRound(data.fdp_match.votes, data.fdp_match.table, data.fdp_match.blackCard);
            }
        }
    }

    // Sincronizar Mﾃ｣o
    onValue(ref(db, `rooms/${roomCode}/players/${myId}/hand_fdp`), (snap) => {
        if(snap.exists()) {
            hand = snap.val();
            const status = document.getElementById('game-status').innerText;
            if(status.includes("ESCOLHA")) renderHand(hand);
        } else {
            fillHand();
        }
    });

    // Sincronizar Vencedor da Rodada
    onValue(ref(db, `rooms/${roomCode}/fdp_match/winner`), (snap) => {
        const win = snap.val();
        if(win && !gameOver) {
            document.getElementById('winner-name').innerText = win.name;
            document.getElementById('winner-card-display').innerHTML = `
                <div style="font-size:0.75rem; opacity:0.6; margin-bottom:15px; border-bottom:1px solid #ccc; padding-bottom:10px;">${win.black}</div>
                <div style="font-size:1.4rem;">${win.text}</div>
            `;
            els.modalWinner.style.display = 'flex';
        } else {
            els.modalWinner.style.display = 'none';
        }
    });

    /* --- INTERFACE UPDATER --- */
    function updateInterface(matchData) {
        document.getElementById('black-text').innerText = matchData.blackCard;
        
        const colors = ['#0aff60', '#b537f2', '#ff2a6d', '#f5e625'];
        const color = colors[(matchData.roundCount || 0) % colors.length];
        els.ambilight.style.background = `radial-gradient(circle at 50% 30%, ${color}, #000)`;

        // --- FASE 1: ESCOLHER CARTA (PICKING) ---
        if(matchData.state === 'PICKING') {
            els.table.style.display = 'none';
            els.modalWinner.style.display = 'none';
            
            const myPlay = matchData.table ? matchData.table[myId] : null;
            
            if(myPlay) {
                els.status.innerText = "ESPERANDO OS OUTROS...";
                els.hand.style.display = 'none';
                els.btnAction.style.display = 'none';
                
                if(matchData.table) {
                    const count = Object.keys(matchData.table).length;
                    els.status.innerText = `AGUARDANDO (${count} JOGARAM)...`;
                }
            } else {
                els.status.innerText = "ESCOLHA SUA MELHOR CARTA";
                els.hand.style.display = 'flex';
                els.btnAction.style.display = 'none'; 
                renderHand(hand);
            }
        }

        // --- FASE 2: VOTAﾃﾃグ (DEMOCRACIA) ---
        else if (matchData.state === 'VOTING') {
            els.hand.style.display = 'none';
            els.btnAction.style.display = 'none';
            els.table.style.display = 'grid';
            
            const myVote = matchData.votes ? matchData.votes[myId] : null;
            
            if(myVote) {
                els.status.innerText = "VOTO COMPUTADO. AGUARDANDO...";
            } else {
                els.status.innerText = "VOTE NA CARTA MAIS ENGRAﾃ②DA!";
            }

            renderVotingTable(matchData.table, matchData.votes, !!myVote);
        }
    }

    /* --- RENDER FUNCTIONS --- */
    function renderHand(handData) {
        els.hand.innerHTML = '';
        handData.forEach((text, idx) => {
            const card = document.createElement('div');
            card.className = 'fdp-card card-white hand-card';
            card.innerHTML = text;
            card.onclick = () => {
                document.querySelectorAll('.hand-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedCardIdx = idx;
                els.btnAction.style.display = 'block';
                els.btnAction.innerText = "JOGAR CARTA";
                els.btnAction.onclick = submitCard;
            };
            els.hand.appendChild(card);
        });
    }

    function renderVotingTable(tableData, votesData, iVoted) {
        els.table.innerHTML = '';
        if(!tableData) return;

        Object.entries(tableData).forEach(([uid, item], idx) => {
            const card = document.createElement('div');
            card.className = 'fdp-card card-white table-card';
            card.innerHTML = item.text; 
            
            let voteCount = 0;
            if(votesData) {
                Object.values(votesData).forEach(votedId => { if(votedId === uid) voteCount++; });
            }
            if(voteCount > 0) {
                card.innerHTML += `<div class="vote-badge">${voteCount}</div>`;
            }

            if(!iVoted && uid !== myId) {
                card.onclick = () => { if(confirm("Votar nesta carta?")) submitVote(uid); };
            } else if (iVoted) {
                card.style.opacity = '0.5';
                if(votesData && votesData[myId] === uid) {
                     card.style.border = "4px solid var(--neon-pink)";
                     card.style.opacity = "1";
                }
            }
            els.table.appendChild(card);
        });
    }

    function updateScoreBoard(players) {
        els.scoreBoard.innerHTML = '';
        if(!players) return;
        Object.values(players).forEach(p => {
            const score = p.score_fdp || 0;
            els.scoreBoard.innerHTML += `<div class="player-chip"><span>${p.name}</span><div class="score-val">${score}</div></div>`;
        });
    }

    function checkGameOver(players) {
        if(!players || gameOver) return;
        let winner = null;
        Object.values(players).forEach(p => {
            if((p.score_fdp || 0) >= 5) winner = p.name;
        });

        if(winner) {
            gameOver = true;
            document.getElementById('champion-name').innerText = winner;
            els.modalGameover.style.display = 'flex';
            els.modalWinner.style.display = 'none';
        }
    }

    /* --- PLAYER ACTIONS --- */
    function submitCard() {
        if(selectedCardIdx === -1) return;
        const text = hand[selectedCardIdx];
        
        const newHand = [...hand];
        newHand.splice(selectedCardIdx, 1);
        newHand.push(whiteCardsData[Math.floor(Math.random() * whiteCardsData.length)]);
        update(ref(db, `rooms/${roomCode}/players/${myId}`), { hand_fdp: newHand });

        update(ref(db, `rooms/${roomCode}/fdp_match/table/${myId}`), { text: text, ownerName: myName });

        els.hand.style.display = 'none';
        els.btnAction.style.display = 'none';
        // Nﾃ｣o chamamos checkManual aqui mais, deixamos o listener do host fazer
    }

    function submitVote(targetUid) {
        update(ref(db, `rooms/${roomCode}/fdp_match/votes/${myId}`), targetUid);
    }

    function fillHand() {
        const h = [];
        for(let i=0; i<7; i++) h.push(whiteCardsData[Math.floor(Math.random() * whiteCardsData.length)]);
        update(ref(db, `rooms/${roomCode}/players/${myId}`), { hand_fdp: h });
        hand = h;
    }

    /* --- HOST LOGIC --- */
    async function hostStartNewRound() {
        if(!isHost || gameOver) return;
        const matchRef = ref(db, `rooms/${roomCode}/fdp_match`);
        const s = await get(matchRef);
        const current = s.val() || { roundCount: 0 };
        
        if(current.state === 'WINNER') return; // Bloqueia reset duplo

        const nextBlack = blackCards[Math.floor(Math.random() * blackCards.length)];
        
        update(matchRef, {
            state: 'PICKING',
            blackCard: nextBlack,
            table: null,
            votes: null,
            winner: null,
            roundCount: (current.roundCount || 0) + 1
        });
    }

    function hostFinalizeRound(votes, table, blackText) {
        if(!isHost) return;

        const counts = {};
        let maxVotes = 0;
        let winnerId = null;

        if(votes) {
            Object.values(votes).forEach(targetId => {
                counts[targetId] = (counts[targetId] || 0) + 1;
                if(counts[targetId] > maxVotes) {
                    maxVotes = counts[targetId];
                    winnerId = targetId;
                }
            });
        } else {
            // Fallback se ninguﾃｩm votar: escolhe aleatﾃｳrio da mesa
            const entries = Object.keys(table);
            winnerId = entries[Math.floor(Math.random() * entries.length)];
        }

        if(winnerId && table[winnerId]) {
            const winnerCard = table[winnerId];
            
            // Anuncia Vencedor (Isso ativa o modal nos clientes)
            update(ref(db, `rooms/${roomCode}/fdp_match`), {
                state: 'WINNER',
                winner: { name: winnerCard.ownerName, text: winnerCard.text, black: blackText }
            });

            // Pontua
            get(ref(db, `rooms/${roomCode}/players/${winnerId}/score_fdp`)).then(s => {
                const pts = (s.val() || 0) + 1;
                update(ref(db, `rooms/${roomCode}/players/${winnerId}`), { score_fdp: pts });
                
                // Se ninguﾃｩm ganhou o jogo todo, prepara prﾃｳxima rodada
                if(pts < 5) {
                    setTimeout(() => {
                        hostStartNewRoundClean(); 
                    }, 6000); 
                }
            });
        }
    }

    async function hostStartNewRoundClean() {
        const nextBlack = blackCards[Math.floor(Math.random() * blackCards.length)];
        const matchRef = ref(db, `rooms/${roomCode}/fdp_match`);
        const s = await get(matchRef);
        const current = s.val();

        update(matchRef, {
            state: 'PICKING',
            blackCard: nextBlack,
            table: null,
            votes: null,
            winner: null,
            roundCount: (current.roundCount || 0) + 1
        });
    }

</script>
</body>
</html>
