<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cidade Dorme - Definitive Edition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700;900&display=swap');
        :root { --neon-red: #ff4646; --neon-blue: #2d46b9; --neon-green: #1ed760; --neon-gold: #f2e205; --bg-dark: #050505; --glass: rgba(255, 255, 255, 0.12); --font-main: 'Space Grotesk', sans-serif; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-dark); color: white; font-family: var(--font-main); overflow: hidden; height: 100vh; }
        
        .app-container { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 20px; background: radial-gradient(circle at top right, rgba(45, 70, 185, 0.15), transparent); }
        
        /* Glass UI Components */
        .user-identity { background: var(--glass); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .role-badge { padding: 5px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 900; text-transform: uppercase; background: var(--neon-blue); }

        .glass-card { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 32px; padding: 25px; width: 100%; max-width: 420px; margin: auto; text-align: center; }
        .role-title { font-size: 1.8rem; font-weight: 900; text-transform: uppercase; margin: 10px 0; letter-spacing: -1px; }
        
        .btn-main { background: white; color: black; border: none; padding: 18px; border-radius: 100px; font-weight: 900; cursor: pointer; width: 100%; margin-top: 15px; text-transform: uppercase; transition: 0.3s; }
        .btn-main:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .grid-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .action-btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 15px; border-radius: 15px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.8rem; }
        .action-btn.selected { background: var(--neon-blue); border-color: white; transform: scale(0.95); }
        .action-btn.eliminated { opacity: 0.3; text-decoration: line-through; pointer-events: none; }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* Noite e Estados */
        #night-overlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; }
        .status-msg { font-size: 0.8rem; color: var(--neon-gold); margin-top: 10px; font-weight: 700; }
        .reveal-box { margin-top: 20px; padding: 15px; border-radius: 15px; font-weight: 900; display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="user-identity" id="identity-bar" style="visibility: hidden;">
        <div>
            <p style="font-size: 0.6rem; opacity: 0.6;">JOGADOR</p>
            <p id="display-name" style="font-weight: 900;">---</p>
        </div>
        <div style="text-align: right;">
            <p style="font-size: 0.6rem; opacity: 0.6;">STATUS</p>
            <span id="display-role" class="role-badge">Aguardando</span>
        </div>
    </div>

    <div id="screen-setup" class="screen">
        <div class="glass-card">
            <h2 style="font-size: 0.8rem; letter-spacing: 2px;">CONFIGURA√á√ÉO DA SALA</h2>
            <div id="player-list" style="margin: 20px 0; text-align: left; font-size: 0.9rem;"></div>
            <p id="waiting-msg" style="opacity: 0.6;">Aguardando jogadores (m√≠nimo 6)...</p>
            <button class="btn-main" id="btn-start-game" style="display: none;" onclick="startGame()">DISTRIBUIR PAP√âIS</button>
        </div>
    </div>

    <div id="screen-day" class="screen">
        <div class="glass-card">
            <h1 class="role-title" id="day-title">O SOL NASCEU</h1>
            <div id="news-report" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; margin: 15px 0; font-size: 0.9rem;">
                Carregando not√≠cias da manh√£...
            </div>
            
            <div id="voting-section">
                <p style="font-size: 0.7rem; opacity: 0.6; text-transform: uppercase;">Quem deve ser expulso da cidade?</p>
                <div id="day-targets" class="grid-actions"></div>
            </div>

            <button class="btn-main" id="btn-end-day" style="display:none" onclick="goToNight()">ENCERRAR VOTA√á√ÉO</button>
        </div>
    </div>

    <div id="screen-gameover" class="screen">
        <div class="glass-card">
            <h1 id="winner-team" class="role-title">VIT√ìRIA</h1>
            <p id="winner-msg" style="margin-bottom: 20px;"></p>
            <button class="btn-main" onclick="location.reload()">JOGAR NOVAMENTE</button>
        </div>
    </div>
</div>

<div id="night-overlay">
    <i class="fa-solid fa-moon" style="font-size: 3rem; color: var(--neon-blue); margin-bottom: 20px;"></i>
    <h2 id="night-instruction">A CIDADE DORME</h2>
    <p id="night-subtext" style="opacity: 0.6; font-size: 0.8rem; margin: 10px 0 20px 0;">Aguarde o comando do narrador...</p>
    
    <div id="night-actions-grid" class="grid-actions" style="width: 100%; max-width: 400px;"></div>
    
    <div id="detetive-reveal" class="reveal-box"></div>
    
    <p id="night-wait-msg" style="margin-top: 30px; opacity: 0.4; font-size: 0.6rem;">Aguardando outros jogadores agirem...</p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB1buacNarLY8ELWla6yeqTi4L0vTdloSc",
        authDomain: "wrapped-fad94.firebaseapp.com",
        databaseURL: "https://wrapped-fad94-default-rtdb.firebaseio.com",
        projectId: "wrapped-fad94",
        storageBucket: "wrapped-fad94.firebasestorage.app",
        messagingSenderId: "360236097664",
        appId: "1:360236097664:web:76777f529c18623bf1c665"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room') || "TRIBUNAL_1";
    const myId = localStorage.getItem('wrapped_uid') || "user_" + Math.random().toString(36).substr(2, 5);
    localStorage.setItem('wrapped_uid', myId);

    let gameState = {};
    let isHost = false;

    // --- ENTRADA NA SALA ---
    async function joinRoom() {
        const name = prompt("Seu Nome:") || "Jogador";
        const roomRef = ref(db, `rooms/${roomCode}`);
        const snap = await get(roomRef);
        
        if (!snap.exists()) {
            isHost = true;
            await set(roomRef, {
                host: myId,
                status: 'waiting',
                phase: 'lobby',
                history: 'Bem-vindo ao Tribunal.',
                players: { [myId]: { name, role: 'Cidad√£o', isAlive: true, isBot: false } }
            });
        } else {
            await update(ref(db, `rooms/${roomCode}/players/${myId}`), { 
                name, role: 'Cidad√£o', isAlive: true, isBot: false 
            });
        }
    }

    joinRoom();

    // --- LOOP PRINCIPAL ---
    onValue(ref(db, `rooms/${roomCode}`), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        gameState = data;
        isHost = data.host === myId;

        updateUI();
        checkWinCondition();
    });

    function updateUI() {
        const me = gameState.players[myId];
        if (!me) return;

        // Header
        document.getElementById('identity-bar').style.visibility = 'visible';
        document.getElementById('display-name').innerText = me.name;
        document.getElementById('display-role').innerText = me.isAlive ? me.role : "MORTO";
        document.getElementById('display-role').style.background = me.role === 'Assassino' ? 'var(--neon-red)' : 'var(--neon-blue)';

        // Telas
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('night-overlay').style.display = 'none';

        if (gameState.status === 'gameover') {
            document.getElementById('screen-gameover').classList.add('active');
            return;
        }

        if (gameState.phase === 'lobby') {
            document.getElementById('screen-setup').classList.add('active');
            renderLobby();
        } else if (gameState.phase === 'day') {
            document.getElementById('screen-day').classList.add('active');
            renderDay();
        } else if (gameState.phase === 'night') {
            document.getElementById('night-overlay').style.display = 'flex';
            renderNight();
        }
    }

    // --- L√ìGICA DE LOBBY ---
    function renderLobby() {
        const list = document.getElementById('player-list');
        const pArray = Object.values(gameState.players);
        list.innerHTML = pArray.map(p => `<div>‚Ä¢ ${p.name} <span style="font-size:0.6rem; opacity:0.5">${p.isBot ? '(BOT)' : ''}</span></div>`).join('');
        
        if (isHost) {
            document.getElementById('btn-start-game').style.display = 'block';
            document.getElementById('waiting-msg').style.display = 'none';
        }
    }

    window.startGame = async () => {
        let players = { ...gameState.players };
        const ids = Object.keys(players);
        
        // Preencher com bots se tiver menos de 6
        if (ids.length < 6) {
            for (let i = ids.length; i < 6; i++) {
                const bId = `bot_${i}`;
                players[bId] = { name: `Bot ${i} ü§ñ`, role: 'Cidad√£o', isAlive: true, isBot: true };
                ids.push(bId);
            }
        }

        // Distribuir Pap√©is
        const shuffled = ids.sort(() => Math.random() - 0.5);
        players[shuffled[0]].role = 'Assassino';
        players[shuffled[1]].role = 'Detetive';
        players[shuffled[2]].role = 'Anjo';

        await update(ref(db, `rooms/${roomCode}`), {
            players,
            phase: 'night',
            status: 'active',
            nightActions: { kill: "", save: "", check: "" }
        });
    };

    // --- L√ìGICA DA NOITE ---
    function renderNight() {
        const me = gameState.players[myId];
        const instr = document.getElementById('night-instruction');
        const grid = document.getElementById('night-actions-grid');
        grid.innerHTML = "";
        
        if (!me.isAlive) {
            instr.innerText = "VOC√ä EST√Å MORTO";
            return;
        }

        if (me.role === 'Cidad√£o') {
            instr.innerText = "A CIDADE DORME...";
            return;
        }

        // A√ß√µes espec√≠ficas
        instr.innerText = `VOC√ä √â O ${me.role.toUpperCase()}`;
        const actionDone = (me.role === 'Assassino' && gameState.nightActions.kill) ||
                           (me.role === 'Anjo' && gameState.nightActions.save) ||
                           (me.role === 'Detetive' && gameState.nightActions.check);

        if (actionDone) {
            document.getElementById('night-subtext').innerText = "A√ß√£o realizada. Aguardando amanhecer...";
            return;
        }

        Object.entries(gameState.players).forEach(([id, p]) => {
            if (p.isAlive && id !== myId) {
                const btn = document.createElement('button');
                btn.className = "action-btn";
                btn.innerText = p.name;
                btn.onclick = () => handleNightAction(me.role, id);
                grid.appendChild(btn);
            }
        });
    }

    async function handleNightAction(role, targetId) {
        const updates = {};
        if (role === 'Assassino') updates['nightActions/kill'] = targetId;
        if (role === 'Anjo') updates['nightActions/save'] = targetId;
        if (role === 'Detetive') {
            updates['nightActions/check'] = targetId;
            const isKiller = gameState.players[targetId].role === 'Assassino';
            const reveal = document.getElementById('detetive-reveal');
            reveal.style.display = 'block';
            reveal.style.background = isKiller ? 'var(--neon-red)' : 'var(--neon-green)';
            reveal.innerText = isKiller ? "ALVO CULPADO üíÄ" : "ALVO INOCENTE üõ°Ô∏è";
        }
        await update(ref(db, `rooms/${roomCode}`), updates);
        
        if (isHost) checkNightResolution();
    }

    // --- L√ìGICA DO DIA ---
    function renderDay() {
        document.getElementById('news-report').innerText = gameState.history;
        const grid = document.getElementById('day-targets');
        grid.innerHTML = "";

        Object.entries(gameState.players).forEach(([id, p]) => {
            if (p.isAlive) {
                const btn = document.createElement('button');
                btn.className = `action-btn ${gameState.dayVotes?.[myId] === id ? 'selected' : ''}`;
                btn.innerText = p.name;
                btn.onclick = () => update(ref(db, `rooms/${roomCode}/dayVotes`), { [myId]: id });
                grid.appendChild(btn);
            }
        });

        if (isHost) document.getElementById('btn-end-day').style.display = 'block';
    }

    // --- PROCESSAMENTO (HOST APENAS) ---
    async function checkNightResolution() {
        // Simular bots agindo
        const acts = gameState.nightActions || {};
        const players = gameState.players;
        
        let updates = {};
        Object.entries(players).forEach(([id, p]) => {
            if (p.isBot && p.isAlive) {
                const targets = Object.keys(players).filter(tid => tid !== id && players[tid].isAlive);
                const randomTarget = targets[Math.floor(Math.random() * targets.length)];
                if (p.role === 'Assassino' && !acts.kill) acts.kill = randomTarget;
                if (p.role === 'Anjo' && !acts.save) acts.save = randomTarget;
                if (p.role === 'Detetive' && !acts.check) acts.check = randomTarget;
            }
        });

        if (acts.kill && acts.save && acts.check) {
            let history = "";
            if (acts.kill === acts.save) {
                history = "O Assassino tentou atacar, mas o Anjo salvou a v√≠tima!";
            } else {
                const victimName = players[acts.kill].name;
                history = `${victimName} foi assassinado durante a noite!`;
                await update(ref(db, `rooms/${roomCode}/players/${acts.kill}`), { isAlive: false });
            }
            
            await update(ref(db, `rooms/${roomCode}`), {
                phase: 'day',
                history: history,
                nightActions: { kill: "", save: "", check: "" },
                dayVotes: {}
            });
        }
    }

    window.goToNight = async () => {
        const votes = gameState.dayVotes || {};
        const counts = {};
        Object.values(votes).forEach(v => counts[v] = (counts[v] || 0) + 1);
        
        const sorted = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
        if (sorted[0]) {
            const victim = sorted[0];
            const victimName = gameState.players[victim].name;
            const role = gameState.players[victim].role;
            
            await update(ref(db, `rooms/${roomCode}/players/${victim}`), { isAlive: false });
            await update(ref(db, `rooms/${roomCode}`), {
                phase: 'night',
                history: `A cidade expulsou ${victimName}. Ele era ${role}!`,
                dayVotes: {}
            });
        } else {
            await update(ref(db, `rooms/${roomCode}`), { phase: 'night' });
        }
    };

    function checkWinCondition() {
        if (gameState.status !== 'active') return;
        
        const alive = Object.values(gameState.players).filter(p => p.isAlive);
        const killers = alive.filter(p => p.role === 'Assassino');
        const citizens = alive.filter(p => p.role !== 'Assassino');

        if (killers.length === 0) {
            endGame("A CIDADE VENCEU", "Todos os assassinos foram eliminados!");
        } else if (killers.length >= citizens.length) {
            endGame("OS ASSASSINOS VENCERAM", "A m√°fia agora controla a cidade.");
        }
    }

    async function endGame(title, msg) {
        if (!isHost) return;
        await update(ref(db, `rooms/${roomCode}`), {
            status: 'gameover',
            victoryTitle: title,
            victoryMsg: msg
        });
        document.getElementById('winner-team').innerText = title;
        document.getElementById('winner-msg').innerText = msg;
    }

</script>
</body>
</html>
